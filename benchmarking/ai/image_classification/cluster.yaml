cluster_name: image-classification-cluster
provider:
  type: aws
  region: us-west-2
  cache_stopped_nodes: false

auth:
  ssh_user: ec2-user

max_workers: 8

available_node_types:
  ray.head.default:
    resources: {"CPU": 0, "GPU": 0}
    node_config:
      InstanceType: g6.2xlarge
      ImageId: ami-0976479b866d22613
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeType: gp3
          VolumeSize: 100
          DeleteOnTermination: true
          Encrypted: true

  ray.worker.default:
    min_workers: 8
    max_workers: 8
    resources: {}
    node_config:
      InstanceType: g6.2xlarge
      IamInstanceProfile:
        Arn: arn:aws:iam::941892620273:instance-profile/ray-autoscaler-v1
      ImageId: ami-0976479b866d22613
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeType: gp3
          VolumeSize: 100
          DeleteOnTermination: true
          Encrypted: true

setup_commands:
- sudo mkdir -p /opt/ray/tmp /opt/ray/spill
- sudo chown -R ec2-user:ec2-user /opt/ray
- echo 'export RAY_TMPDIR=/opt/ray/tmp' >> ~/.bashrc
- echo 'export RAY_object_spilling_directory=/opt/ray/spill' >> ~/.bashrc
- source /opt/pytorch/bin/activate && pip install ray[default] daft numpy torch torchvision pillow

head_setup_commands:
- source /opt/pytorch/bin/activate && pip install 'boto3>=1.4.8'

worker_setup_commands: []

head_start_ray_commands:
- source /opt/pytorch/bin/activate && ray stop
- ulimit -n 65536; source /opt/pytorch/bin/activate && ray start --head --port=6379 --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml

worker_start_ray_commands:
- source /opt/pytorch/bin/activate && ray stop
- ulimit -n 65536; source /opt/pytorch/bin/activate && ray start --address=$RAY_HEAD_IP:6379 --object-manager-port=8076
