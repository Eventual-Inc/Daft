cluster_name: ci-benchmark-ai-audio-transcription-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}

provider:
  type: aws
  region: us-west-2
  cache_stopped_nodes: false
  security_group:
    GroupName: ray-autoscaler-c1

auth:
  ssh_user: ec2-user
  ssh_private_key: ~/.ssh/ci-github-actions-ray-cluster-key.pem

max_workers: 8

available_node_types:
  ray.head.default:
    resources: {"CPU": 0, "GPU": 0}
    node_config:
      KeyName: ci-github-actions-ray-cluster-key
      InstanceType: g6.xlarge
      ImageId: ami-0976479b866d22613
      IamInstanceProfile:
        Name: ray-autoscaler-v1
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeType: gp3
          VolumeSize: 100
          DeleteOnTermination: true
          Encrypted: true

  ray.worker.default:
    min_workers: 8
    max_workers: 8
    resources: {}
    node_config:
      KeyName: ci-github-actions-ray-cluster-key
      InstanceType: g6.xlarge
      ImageId: ami-0976479b866d22613
      IamInstanceProfile:
        Name: arn:aws:iam::941892620273:instance-profile/
      BlockDeviceMappings:
      - DeviceName: /dev/xvda
        Ebs:
          VolumeType: gp3
          VolumeSize: 100
          DeleteOnTermination: true
          Encrypted: true

setup_commands:
- sudo mkdir -p /opt/ray/tmp /opt/ray/spill
- sudo chown -R ec2-user:ec2-user /opt/ray
- echo 'export RAY_TMPDIR=/opt/ray/tmp' >> ~/.bashrc
- echo 'export RAY_object_spilling_directory=/opt/ray/spill' >> ~/.bashrc
- source /opt/pytorch/bin/activate && pip install ray[default]==2.49.2 numpy==1.26.4 accelerate==1.10.1 transformers==4.56.2 torchaudio==2.7.0+cu128 soundfile==0.13.1
- source /opt/pytorch/bin/activate && pip install daft --pre --extra-index-url ${DAFT_INDEX_URL}

head_setup_commands:
- source /opt/pytorch/bin/activate && pip install 'boto3>=1.4.8'

worker_setup_commands: []

head_start_ray_commands:
- source /opt/pytorch/bin/activate && ray stop
- ulimit -n 65536; source /opt/pytorch/bin/activate && ray start --head --port=6379 --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml

worker_start_ray_commands:
- source /opt/pytorch/bin/activate && ray stop
- ulimit -n 65536; source /opt/pytorch/bin/activate && ray start --address=$RAY_HEAD_IP:6379 --object-manager-port=8076
