name: Force Merge Check
permissions:
  contents: read

on:
  pull_request_target:
    types: [labeled, synchronize, opened, reopened]

jobs:
  force-merge:
    if: contains(github.event.pull_request.labels.*.name, 'force-merge')
    runs-on: ubuntu-latest
    steps:
    - name: Check if user is in engineering team
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prUser = context.payload.pull_request.user.login;

          try {
            const { data: membership } = await github.request(
              'GET /orgs/{org}/teams/{team_slug}/memberships/{username}',
              {
                org: 'Eventual-Inc',
                team_slug: 'engineering',
                username: prUser,
              }
            );

            if (membership.state !== "active") {
              core.setFailed(`User ${prUser} exists but is not active in Eventual-Inc/engineering.`);
            } else {
              console.log(`âœ… User ${prUser} is in engineering team, force merge allowed.`);
            }
          } catch (error) {
            core.error(`GitHub API request failed: ${error.message}`);
            core.setFailed(`Could not verify membership for ${prUser}.`);
          }
