name: datagen

on:
  push:
  workflow_dispatch:
    inputs:
      bench_type:
        description: The type of benchmark to generate data for
        type: choice
        options:
        - tpcds
        - tpch
        required: true
      scale_factor:
        description: The scale factor of data (in GB) to generate
        type: number
        required: true
      num_partitions:
        description: The number of partitions to generate
        type: number
        required: false
        default: 1

jobs:
  generate-data:
    runs-on: [self-hosted, linux, x64, ci-dev]
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Log workflow inputs
      run: echo "${{ toJson(github.event.inputs) }}"
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-west-2
        role-session-name: run-command-workflow
    - name: Install uv, rust, python
      uses: ./.github/actions/install
      with:
        python_version: ${{ inputs.python_version }}
    - name: Generate data
      run: |
        uv run tools/datagen.py \
          ${{ inputs.bench_type }} \
          --scale-factor=${{ inputs.scale_factor }} \
          --num-partitions=${{ inputs.num_partitions }}

    - uses: lhotari/action-upterm@v1
